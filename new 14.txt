import React, { useState, useEffect, useRef, useCallback } from "react";
import { MdKeyboardDoubleArrowRight } from "react-icons/md";
import { useNavigate } from "react-router-dom";
import Loginlayout from "../Layout/Login/Loginlayout";
import servicecall from "../../Services/servicecall";
import PasswordPolicy from "../Login/PasswordPolicy";
import { getOSName } from "../../Services/CF_osName";
import { CF_sessionSet } from "../Common/CF_session";
import { CF_DeviceChecking } from "../Common/CF_device";
import { CF_encrypt, CF_decrypt } from "../Common/encryptiondecryption";
import { motion, AnimatePresence } from "framer-motion";
import ForgotPassword from "../Login/Emailverification";
import Errordialog from "../Layout/Common/Errordialog";
import Verificationcode from "./Verificationcode";
import Cookies from "js-cookie";
import AnimatedDropdown from '../Layout/Common/AnimatedDropdown';

// Import useHooks
import { 
  useToggle, 
  useDebounce, 
  useEventListener, 
  useKeyPress,
  useClickAway 
} from "@uidotdev/usehooks";

function LoginForm({ onNavigate }) {
  const initialForm = {
    username: "",
    password: "",
    site: "",
    domain: "",
    timeZone: "",
    language: "english",
  };

  const [form, setForm] = useState(initialForm);
  const [sites, setSites] = useState([]);
  const [domains, setDomains] = useState([]);
  const [timeZones, setTimeZones] = useState([]);
  const [errors, setErrors] = useState({});
  
  // REPLACED: useState with useToggle for boolean states
  const [showMoreInfo, toggleMoreInfo] = useToggle(false);
  const [showPolicyModal, togglePolicyModal] = useToggle(false);
  const [showForgotPassword, toggleForgotPassword] = useToggle(false);
  const [showVerfication, toggleVerification] = useToggle(false);
  
  const [passwordExpiryMsg, setPasswordExpiryMsg] = useState("");
  const [validated, setValidated] = useState(false);
  const [userCategory, setUserCategory] = useState("");
  const [loading, setLoading] = useState(false);
  const [userEmail, setUserEmail] = useState("");
  const [showTimeZone, setShowTimeZone] = useState();

  const osNameRef = useRef("");
  const passwordRef = useRef(null);
  const usernameRef = useRef(null);
  const policyModalRef = useRef(null);
  const forgotPasswordRef = useRef(null);
  const verificationRef = useRef(null);
  
  const navigate = useNavigate();
  const { postData } = servicecall();
  const hasLoadedOnce = useRef(true);
  
  const fieldNames = {
    username: "username",
    password: "password",
    site: "site",
    domain: "domain",
    timeZone: "timeZone",
    language: "language",
  };

  const [dialogData, setDialogData] = useState({
    open: false,
    message: "",
    type: "",
  });

  const showDialog = useCallback((message, type = "error") => {
    setDialogData({ open: true, message, type });
  }, []);

  const handleDialogClose = useCallback(() => {
    if (dialogData.type === "success") {
      navigate("/Login");
    }
    setDialogData({ open: false, message: "", type: "" });
  }, [dialogData.type, navigate]);

  const getCookie = useCallback((name) => {
    return Cookies.get(name) || "";
  }, []);

  const setCookie = useCallback((name, value, options = {}) => {
    Cookies.set(name, value, { path: "/", ...options });
  }, []);

  const removeCookie = useCallback((name) => {
    Cookies.remove(name, { path: "/" });
  }, []);

  // ADDED: Debounce username for validation
  const debouncedUsername = useDebounce(form.username, 300);

  // REPLACED: useEffect with useEventListener for beforeunload
  const handleBeforeUnload = useCallback(() => {
    removeCookie("sUsername");
    setForm((prev) => ({ ...prev, username: "" }));
    removeCookie("sitecode");
  }, [removeCookie]);

  useEventListener("beforeunload", handleBeforeUnload);

  // ADDED: useClickAway for modals
  useClickAway(policyModalRef, () => {
    if (showPolicyModal) togglePolicyModal();
  });

  useClickAway(forgotPasswordRef, () => {
    if (showForgotPassword) toggleForgotPassword();
  });

  useClickAway(verificationRef, () => {
    if (showVerfication) toggleVerification();
  });

  // One Time Load initialize
  useEffect(() => {
    const initialize = async () => {
      try {
        getOSName((result) => (osNameRef.current = result));

        const encryptedUsername = getCookie("sUsername");
        if (encryptedUsername) {
          try {
            const decrypted = CF_decrypt(encryptedUsername);
            setForm((prev) => ({ ...prev, username: decrypted }));
            setValidated(true);
          } catch {}
        }

        const siteData = await postData("Login/LoadSite", {});
        const siteList = siteData.sitelist || [];
        setSites(siteList);

        const currentSite = siteList?.[0]?.sSiteCode || "";
        setForm((prev) => ({ ...prev, site: currentSite }));

        if (currentSite) {
          const domainData = await postData("Login/LoadDomainCombo", {
            sSiteCode: currentSite,
          });
          const domainList = domainData || [];
          setDomains(domainList);

          if (domainList.length > 0) {
            const defaultDomain = domainList[0].sDomainName;
            setForm((prev) => ({ ...prev, domain: defaultDomain }));
            setUserCategory(defaultDomain);
          } else {
            setUserCategory("");
          }
        }

        const tzData = await postData("Login/getTimeZones", {});
        const timeZonesList = tzData.TimeZones || [];
        setTimeZones(timeZonesList);

        let browserLocalTimeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;
        if (browserLocalTimeZone === "Asia/Calcutta") browserLocalTimeZone = "Asia/Kolkata";

        const foundTZ = timeZonesList.find(
          (t) =>
            t.sTimeZoneValue === browserLocalTimeZone ||
            t.sTimeZoneValue.includes(browserLocalTimeZone) ||
            browserLocalTimeZone.includes(t.sTimeZoneValue)
        );

        if (foundTZ) {
          setForm((prev) => ({ ...prev, timeZone: foundTZ.sTimeZoneID }));
        }

        const sUTCStatus = tzData["UTCStatus"] ? "true" : "false";
        CF_sessionSet("UTCStatus", sUTCStatus, 1);
        setShowTimeZone(!!tzData["UTCStatus"]);

        const sShowUTCcol = tzData["sShowUTCcol"] ? "true" : "false";
        CF_sessionSet("sShowUTCcol", sShowUTCcol, 1);
        hasLoadedOnce.current = false;
      } catch (err) {
        console.log(`Error: ${err}`);
        showDialog("Something went wrong", "warning");
      }
    };
    initialize();
  }, []);

  // CLOSE DIALOG ON ENTER KEY
  useEffect(() => {
    if (!dialogData.open) return;

    const handleKeyDown = (e) => {
      if (e.key === "Enter" && dialogData.open) {
        e.preventDefault();
        e.stopPropagation();
        handleDialogClose();
      }
    };

    window.addEventListener("keydown", handleKeyDown);
    return () => window.removeEventListener("keydown", handleKeyDown);
  }, [dialogData.open, handleDialogClose]);

  // Validating the Users
  const validateUser = useCallback(async () => {
    if (!form.username.trim() && validated === true) {
      setValidated(false);
      usernameRef.current?.focus();
      return;
    }
    if (form.username.trim() === "") {
      setValidated(false);
      usernameRef.current?.focus();
      setErrors({ [fieldNames.username]: "Please enter username." });

      setTimeout(() => {
        setErrors((prev) => ({
          ...prev,
          [fieldNames.username]: "",
        }));
      }, 3000);

      return;
    }

    try {
      const obj = { sUsername: form.username.trim(), sSiteCode: form.site };
      const data = await postData("Login/NewpasswordGenerationValidation", obj);
      const info = data?.oResObj?.targetSource?.target?.sInformation || data?.oResObj?.sInformation;
      const expiryDays = data?.oResObj?.targetSource?.target?.nPasswrdExpirydays;

      if (info?.toLowerCase().includes("invalid user")) {
        setErrors({ [fieldNames.username]: "Invalid User, Please check your username." });
        usernameRef.current?.focus();
        setValidated(false);
        return;
      }

      setErrors({});
      setValidated(true);

      setCookie("sUsername", CF_encrypt(form.username));
      setCookie("sitecode", CF_encrypt(form.site));

      if (info === "Password Expiry" && (expiryDays === 0 || data.oResObj.bPasswrdExpiryStatus)) {
        onNavigate("changepassword");
        return;
      }

      if (expiryDays >= 1 && expiryDays <= 5) {
        setPasswordExpiryMsg(`Password is valid for another ${expiryDays} day(s).`);
      }

      if (info === "GenerateNewPassword") {
        onNavigate("createpassword");
      } else if (info === "PolicyChanged") togglePolicyModal();
    } catch (err) {
      console.error(err);
    }
  }, [form.username, form.site, validated, postData, setCookie, navigate]);

  // ADDED: Auto-validate on debounced username change
  useEffect(() => {
    if (debouncedUsername.trim() && !validated) {
      validateUser();
    }
  }, [debouncedUsername]);

  // REPLACED: Manual keyboard handling with useKeyPress
  const tabPressed = useKeyPress("Tab");
  const enterPressed = useKeyPress("Enter");

  useEffect(() => {
    if (tabPressed && document.activeElement === usernameRef.current) {
      if (form.username.trim()) validateUser();
      passwordRef.current?.focus();
    }
  }, [tabPressed]);

  useEffect(() => {
    if (enterPressed && document.activeElement === usernameRef.current) {
      passwordRef.current?.focus();
    }
  }, [enterPressed]);

  const handleChange = useCallback((e) => {
    const { name, value } = e.target;
    setForm((prev) => ({ ...prev, [name]: value }));
  }, []);

  // Submitting Logic
  const handleSubmit = useCallback(
    async (e) => {
      e.preventDefault();

      if (!form.username.trim()) {
        setErrors({ [fieldNames.username]: "Please enter username." });
        return;
      }
      if (!form.password.trim()) {
        setErrors({ [fieldNames.password]: "Please enter password." });
        return;
      }

      setLoading(true);
      try {
        const guid = new URLSearchParams(window.location.search).get("GUID");
        const tenantID = new URLSearchParams(window.location.search).get("TenantID") || "";

        const reqObj = {
          sAvailableLicenseURL: "http://AGL107:8095/LicenseAPI/License/getAvailableLicenseCount",
          loginObj: {
            bScreenLock: false,
            sDomainName: form.domain || "SDMS",
            sUsername: form.username,
            sSiteCode: form.site,
            sCategories: domains[0]?.sCategories,
            sClientMachineName: osNameRef.current,
            sPassword: form.password,
          },
          sLoginFrom: guid ? "SharedLink" : "SDMS",
        };

        const response = await postData("Login/Login", reqObj);
        const info = response?.oResObj?.sInformation || response?.oResObj?.targetSource?.target?.sInformation;
        const status = response?.oResObj?.bStatus ?? response?.oResObj?.targetSource?.target?.bStatus;

        if (status && info === "Login Success") {
          setErrors({ username: "", password: "" });
          const data = response;

          // SESSION SET
          CF_sessionSet("sCategories", data.oResObj1.sCategories, 1);
          CF_sessionSet("sSiteCode", data.oResObj1.sSiteCode, 1);
          CF_sessionSet("sUserGroupID", data.oResObj1.sUserGroupID, 1);
          CF_sessionSet("sUserGroupName", data.oResObj1.sUserGroupName, 1);
          CF_sessionSet("sUserID", data.oResObj1.sUserID, 1);
          CF_sessionSet("sSiteName", data.oResObj1.sSiteName, 1);
          CF_sessionSet("sUsername", data.oResObj1.sUsername, 1);
          CF_sessionSet("sUserStatus", data.oResObj1.sUserStatus, 1);
          CF_sessionSet("sDomainName", data.oResObj1.sDomainName, 1);
          CF_sessionSet("nIdleTime", data.oResObj.nIdealTime, 0);
          CF_sessionSet("sLanguage", form.language, 1);
          CF_sessionSet("sTimeZoneID", form.timeZone, 1);
          CF_sessionSet(
            "sTimeZoneValue",
            timeZones.find((t) => t.sTimeZoneID === form.timeZone)?.sTimeZoneValue || "",
            1
          );
          CF_sessionSet("DownloadLinkLogoff", data.DownloadLinkLogoff, 0);
          CF_sessionSet("ConcurrentUsersAvailableCount", data.oResObj.concurrentUsersAvailableCount, 0);
          CF_sessionSet("upd", form.password, 1);
          CF_sessionSet("sSessionID", data.oResObj1.sSessionID, 1);
          CF_sessionSet("sdbtype", data.sdbtype, 1);
          CF_sessionSet("sTenantID", tenantID, 1);
          CF_sessionSet("isLoggedIn", data.oResObj.sInformation, 0);

          const checker = CF_DeviceChecking();
          CF_sessionSet("device", checker.android || checker.iphone || checker.blackberry ? "tablet" : "desktop", 1);

          if (guid) {
            const expiryMinutes = data.DownloadLinkLogoff || 5;
            const expires = new Date(Date.now() + expiryMinutes * 60 * 1000);
            const cookieOptions = `; path=/; expires=${expires.toUTCString()}`;

            document.cookie = `sCategories=${CF_encrypt(data.oResObj1.sCategories)}${cookieOptions}`;
            document.cookie = `sSiteCode=${CF_encrypt(data.oResObj1.sSiteCode)}${cookieOptions}`;
            document.cookie = `sUserGroupID=${CF_encrypt(data.oResObj1.sUserGroupID)}${cookieOptions}`;
            document.cookie = `sUserID=${CF_encrypt(data.oResObj1.sUserID)}${cookieOptions}`;
            document.cookie = `sUsername=${CF_encrypt(data.oResObj1.sUsername)}${cookieOptions}`;
            document.cookie = `nIdleTime=${data.oResObj.nIdealTime}${cookieOptions}`;
            document.cookie = `sUserGroupName=${CF_encrypt(data.oResObj1.sUserGroupName)}${cookieOptions}`;
            document.cookie = `sSessionID=${CF_encrypt(data.oResObj1.sSessionID)}${cookieOptions}`;
            document.cookie = `sTenantID=${CF_encrypt(tenantID)}${cookieOptions}`;

            CF_sessionSet("linkPath", window.location.href, 1);
            CF_sessionSet("reload", 1, 0);
            navigate("/guid");
          } else {
            if (data.sProfileImageBytes) CF_sessionSet("sProfileImageBytes", data.sProfileImageBytes, 0);
            CF_sessionSet("iPortalStatus", data.iPortalStatus ? "true" : "false", 1);
            navigate("/Home");
            removeCookie("sUsername");
            setForm((prev) => ({ ...prev, username: "" }));
            removeCookie("sitecode");
          }
        } else {
          passwordRef.current?.focus();
          const errorMsg = info || "Invalid password. Please try again.";
          showDialog(errorMsg, "error");
        }
      } catch (err) {
        console.error(err);
        setErrors({ [fieldNames.username]: "Unable to connect to server. Please try again." });
      } finally {
        setLoading(false);
      }
    },
    [form, domains, timeZones, postData, navigate, showDialog]
  );

  // Forgot Password
  const handleForgotPassword = useCallback(async () => {
    if (!form.username.trim()) {
      showDialog("Please enter username before recovering password.", "error");
      return;
    } else {
      document.cookie = `sUsername=${encodeURIComponent(CF_encrypt(form.username))}; path=/`;
      document.cookie = `sitecode=${encodeURIComponent(CF_encrypt(form.site))}; path=/`;
    }

    try {
      const req = {
        sUsername: form.username.trim(),
        sSiteCode: form.site.trim(),
      };

      const res = await postData("Login/getUserEmailID", req);

      const email = res?.sUserMailID?.trim() || "";

      if (!email) {
        showDialog("Email ID is mandatory for password recovery. Please contact the Administrator.", "info");
        return;
      }

      setUserEmail(email);
      toggleForgotPassword(); // CHANGED: Using toggle
    } catch (err) {
      console.error(err);
      showDialog("Unable to fetch email ID. Please try again later.", "error");
    }
  }, [form.username, form.site, postData, showDialog, setCookie]);

  const handleVerificationOpen = useCallback(() => {
    toggleForgotPassword(); // Close forgot password
    toggleVerification(); // Open verification
  }, []);

  return (
    <>
      <form onSubmit={handleSubmit}>
        {/* Username */}
        <div className="mb-3">
          <label className="text-sm font-medium text-gray-600">Username</label>
          <input
            ref={usernameRef}
            type="text"
            name={fieldNames.username.trimStart()}
            value={form.username}
            onChange={(e) => {
              const val = e.target.value;
              setForm({ ...form, username: val });
              setCookie("sUsername", CF_encrypt(val));
            }}
            autoComplete="off"
            className="w-full text-sm font-semibold border-b-2 border-gray-300 focus:border-blue-500 outline-none"
          />
          {errors.username && <p className="text-red-500 text-sm">{errors.username}</p>}
        </div>

        {/* Password */}
        <div className="mb-6">
          <label className="text-sm font-medium text-gray-600">Password</label>
          <input
            ref={passwordRef}
            type="password"
            name={fieldNames.password}
            value={form.password}
            onChange={handleChange}
            onFocus={validateUser}
            className="w-full text-sm font-semibold border-b-2 border-gray-300 focus:border-blue-500 outline-none"
          />
          {passwordExpiryMsg && <p className="text-yellow-600 text-sm">{passwordExpiryMsg}</p>}
          {errors.password && <p className="text-red-500 text-sm">{errors.password}</p>}
        </div>

        {/* More Info Section */}
        <div className="mb-6">
          <button
            type="button"
            onClick={toggleMoreInfo} // CHANGED: Direct toggle function
            className="text-sm hover:font-bold font-semibold text-blue-600 hover:underline hover:translate-x-1 transform-all flex items-center"
          >
            More Information
            <MdKeyboardDoubleArrowRight
              className={`mt-[4px] ml-1 transition-transform duration-300 ${showMoreInfo ? "rotate-90" : "rotate-0"}`}
            />
          </button>
        </div>

        <AnimatePresence>
          {showMoreInfo && (
            <motion.div
              key="more-info"
              initial={{ height: 0, opacity: 0 }}
              animate={{ height: "auto", opacity: 1 }}
              exit={{ height: 0, opacity: 0 }}
              transition={{ duration: 0.4, ease: "easeInOut" }}
              className="mb-6 overflow-visible"
            >
              <AnimatedDropdown
                label="Site"
                name={fieldNames.site}
                value={form.site}
                options={sites}
                displayKey="sSiteName"
                valueKey="sSiteCode"
                onChange={handleChange}
              />

              <AnimatedDropdown
                label="Domain"
                name={fieldNames.domain}
                value={form.domain}
                options={domains}
                displayKey="sDomainName"
                valueKey="sDomainName"
                onChange={handleChange}
              />

              {showTimeZone && (
                <AnimatedDropdown
                  label="Time Zone"
                  name={fieldNames.timeZone}
                  value={form.timeZone}
                  options={timeZones}
                  displayKey="sTimeZoneValue"
                  valueKey="sTimeZoneID"
                  onChange={handleChange}
                  direction="down"
                  isSearchable={true}
                />
              )}

              <AnimatedDropdown
                label="Language"
                name={fieldNames.language}
                value={form.language}
                options={[
                  { label: "English", value: "english" },
                  { label: "Polish", value: "polish" },
                  { label: "Korean", value: "korean" },
                  { label: "French", value: "french" },
                  { label: "Japanese", value: "japanese" },
                ]}
                displayKey="label"
                valueKey="value"
                onChange={handleChange}
                direction="up"
              />
            </motion.div>
          )}
        </AnimatePresence>

        {/* Submit Button */}
        <button type="submit" className="btn-primary hover:scale-95 hover:rounded-md" disabled={loading}>
          {loading ? "Logging in..." : "Login"}
        </button>

        {/* Forgot Password */}
        {validated && userCategory === "SDMS" && (
          <div className="text-center mt-5 mb-[-35px]">
            <button
              type="button"
              onClick={handleForgotPassword}
              className="text-blue-600 text-sm hover:scale-80 hover:underline hover:transform hover:font-bold font-semibold"
            >
              Forgot Password
            </button>
          </div>
        )}
      </form>

      {/* Password Policy Modal */}
      <AnimatePresence>
        {showPolicyModal && (
          <motion.div
            key="password-policy"
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            transition={{ type: "spring", stiffness: 220, damping: 30 }}
            className="fixed inset-0 z-[10000] flex items-center justify-center bg-black/40 backdrop-blur-sm"
          >
            <motion.div
              ref={policyModalRef} // ADDED: ref for useClickAway
              initial={{ scale: 1, opacity: 0 }}
              animate={{ scale: 1, opacity: 1 }}
              exit={{ scale: 1, opacity: 0 }}
              transition={{ duration: 0.3, ease: "easeOut" }}
              className="bg-white rounded-xl shadow-2xl w-[90%] max-w-lg overflow-hidden"
            >
              <PasswordPolicy onClose={togglePolicyModal} /> {/* CHANGED: toggle function */}
            </motion.div>
          </motion.div>
        )}
      </AnimatePresence>

      {/* Forgot Password Modal */}
      <AnimatePresence>
        {showForgotPassword && (
          <motion.div
            key="forgot-password"
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            transition={{ type: "spring", stiffness: 220, damping: 30 }}
            className="fixed inset-0 z-[10000] flex items-start justify-center pt-10 bg-black/40 backdrop-blur-sm "
          >
            <motion.div
              ref={forgotPasswordRef} // ADDED: ref for useClickAway
              initial={{ scale: 1, opacity: 1 }}
              animate={{ scale: 1, opacity: 1 }}
              exit={{ scale: 1, opacity: 1 }}
              transition={{ duration: 0.1, ease: "easeInOut" }}
              className="bg-white rounded-md  shadow-2xl w-[90%] max-w-lg overflow-hidden"
            >
              <ForgotPassword
                onClose={toggleForgotPassword} // CHANGED: toggle function
                onVerificationOpen={handleVerificationOpen}
                userData={{ sUserMailID: userEmail }}
              />
            </motion.div>
          </motion.div>
        )}
      </AnimatePresence>

      <AnimatePresence>
        {showVerfication && (
          <motion.div
            key="verfication"
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            transition={{ type: "spring", stiffness: 220, damping: 30 }}
            className="fixed inset-0 z-[10000] flex items-start justify-center pt-10 bg-black/40 backdrop-blur-sm "
          >
            <motion.div
              ref={verificationRef} // ADDED: ref for useClickAway
              initial={{ scale: 0.95, opacity: 0 }}
              animate={{ scale: 1, opacity: 1 }}
              exit={{ scale: 0.95, opacity: 0 }}
              transition={{ duration: 0.1, ease: "easeInOut" }}
              className="bg-white rounded-md  shadow-2xl w-[90%] max-w-lg overflow-hidden"
            >
              <Verificationcode onClose={toggleVerification} userData={{ sUserMailID: userEmail }} /> {/* CHANGED: toggle */}
            </motion.div>
          </motion.div>
        )}
      </AnimatePresence>

      {dialogData.open && <Errordialog message={dialogData.message} type={dialogData.type} onClose={handleDialogClose} />}
    </>
  );
}

export default LoginForm;
